<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:batch="http://www.springframework.org/schema/batch"
	xmlns:context="http://www.springframework.org/schema/context"
	xsi:schemaLocation="http://www.springframework.org/schema/batch 
		http://www.springframework.org/schema/batch/spring-batch-2.1.xsd
		http://www.springframework.org/schema/context 
		http://www.springframework.org/schema/context/spring-context-3.1.xsd
		http://www.springframework.org/schema/beans 
		http://www.springframework.org/schema/beans/spring-beans-3.0.xsd">

	<description>
		PYMK - Database Sync
	</description>
	
	<bean id="sameCompany" class="com.tianji.r.core.conf.DatabaseJobConf">
		<property name="taskName" value="sameCompany" />
		<property name="remoteExportFile" value="sameCompany.csv" />
		<property name="remoteExportFolder" value="/tmp/" />
		<property name="remoteExportDataSource" ref="qaDataSource"/>
		<property name="remoteExportSCPConection" ref="qaSCPConnection"/>
		<property name="localImportDataSource" ref="rDataSource"/>
		<property name="remoteExportSQL">
			<value>
				<![CDATA[
					SELECT id,account_id,TRIM(name),updated_at
					FROM backgrounds 
					WHERE b_type='c' AND name IS NOT NULL AND TRIM(name) != ''
					LIMIT 100
				]]>
			</value>
		</property>
		<property name="localFolder" value="D:/workspace/java/tianji-recommmendation/metadata/data/" />
		<property name="localImportTable" value="o_same_company" />
		<property name="localImportTableWay" value="OVERRIDE"/><!-- OVERRIDE,APPEND,UPDATE -->
		<property name="localImportTableCreateSQL">
			<list>
				<value>
					<![CDATA[
						CREATE TABLE o_same_company (
						   id INT NOT NULL UNIQUE,
						   user_id INT(11) NOT NULL,  
						   name VARCHAR(255) NOT NULL,           
						   updated_at DATETIME NOT NULL,      
						   PRIMARY KEY (id)   
						 ) ENGINE=MYISAM DEFAULT CHARSET=utf8
					]]>
				</value>
				<value>
					<![CDATA[
						CREATE INDEX o_same_company_IDX_0 on o_same_company(name)
					]]>
				</value>
				<value>
					<![CDATA[
						CREATE INDEX o_same_company_IDX_1 on o_same_company(user_id)
					]]>
				</value>
			</list>
		</property>
		<property name="localImportTableDropSQL">
			<list>
				<value>
					<![CDATA[
						DROP TABLE IF EXISTS o_same_company
					]]>
				</value>
			</list>
		</property>
	</bean>
	
	<bean id="sameSchool" class="com.tianji.r.core.conf.DatabaseJobConf">
		<property name="taskName" value="sameSchool" />
		<property name="remoteExportFile" value="sameSchool.csv" />
		<property name="remoteExportFolder" value="/tmp/" />
		<property name="remoteExportDataSource" ref="qaDataSource"/>
		<property name="remoteExportSCPConection" ref="qaSCPConnection"/>
		<property name="localImportDataSource" ref="rDataSource"/>
		<property name="remoteExportSQL">
			<value>
				<![CDATA[
					SELECT id,account_id,TRIM(name),updated_at
					FROM backgrounds 
					WHERE b_type='s' AND name IS NOT NULL AND TRIM(name) != ''
					LIMIT 100
				]]>
			</value>
		</property>
		<property name="localFolder" value="D:/workspace/java/tianji-recommmendation/metadata/data/" />
		<property name="localImportTable" value="o_same_school" />
		<property name="localImportTableWay" value="OVERRIDE"/><!-- OVERRIDE,APPEND,UPDATE -->
		<property name="localImportTableCreateSQL">
			<list>
				<value>
					<![CDATA[
						CREATE TABLE o_same_school (
						   id INT NOT NULL UNIQUE,
						   user_id INT(11) NOT NULL,  
						   name VARCHAR(255) NOT NULL,           
						   updated_at DATETIME NOT NULL,      
						   PRIMARY KEY (id)   
						) ENGINE=MYISAM DEFAULT CHARSET=utf8
					]]>
				</value>
				<value>
					<![CDATA[
						CREATE INDEX o_same_school_IDX_0 on o_same_school(name)
					]]>
				</value>
			</list>
		</property>
		<property name="localImportTableDropSQL">
			<list>
				<value>
					<![CDATA[
						DROP TABLE IF EXISTS o_same_school
					]]>
				</value>
			</list>
		</property>
	</bean>

	<bean id="addressBooks" class="com.tianji.r.core.conf.DatabaseJobConf">
		<property name="taskName" value="addressBooks" />
		<property name="remoteExportFile" value="addressBooks.csv" />
		<property name="remoteExportFolder" value="/tmp/" />
		<property name="remoteExportDataSource" ref="qaDataSource"/>
		<property name="remoteExportSCPConection" ref="qaSCPConnection"/>
		<property name="localImportDataSource" ref="rDataSource"/>
		<property name="remoteExportSQL">
			<value>
				<![CDATA[
					SELECT id,user_id,email,create_time FROM address_books LIMIT 100
				]]>
			</value>
		</property>
		<property name="localFolder" value="D:/workspace/java/tianji-recommmendation/metadata/data/" />
		<property name="localImportTable" value="o_address_books" />
		<property name="localImportTableWay" value="OVERRIDE"/><!-- OVERRIDE,APPEND,UPDATE -->
		<property name="localImportTableCreateSQL">
			<list>
				<value>
					<![CDATA[
						CREATE TABLE o_address_books (
						   id INT NOT NULL UNIQUE,
						   user_id INT(11) NOT NULL,  
						   email VARCHAR(255) NOT NULL,           
						   create_time DATETIME DEFAULT NULL,     
						   PRIMARY KEY (user_id,email)   
						 ) ENGINE=MYISAM DEFAULT CHARSET=utf8
					]]>
				</value>
				<value>
					<![CDATA[
						CREATE INDEX o_address_books_IDX_0 on o_address_books(create_time)
					]]>
				</value>
			</list>
		</property>
		<property name="localImportTableDropSQL">
			<list>
				<value>
					<![CDATA[
						DROP TABLE IF EXISTS o_address_books
					]]>
				</value>
			</list>
		</property>
	</bean>
	
	<bean id="accounts" class="com.tianji.r.core.conf.DatabaseJobConf">
		<property name="taskName" value="accounts" />
		<property name="remoteExportFile" value="accounts.csv" />
		<property name="remoteExportFolder" value="/tmp/" />
		<property name="remoteExportDataSource" ref="qaDataSource"/>
		<property name="remoteExportSCPConection" ref="qaSCPConnection"/>
		<property name="localImportDataSource" ref="rDataSource"/>
		<property name="remoteExportSQL">
			<value>
				<![CDATA[
					SELECT id,email,updated_at FROM accounts LIMIT 100
				]]>
			</value>
		</property>
		<property name="localFolder" value="D:/workspace/java/tianji-recommmendation/metadata/data/" />
		<property name="localImportTable" value="o_accounts" />
		<property name="localImportTableWay" value="OVERRIDE"/><!-- OVERRIDE,APPEND,UPDATE -->
		<property name="localImportTableCreateSQL">
			<list>
				<value>
					<![CDATA[
						CREATE TABLE o_accounts(
							id INT NOT NULL UNIQUE,  
							email VARCHAR(255) NOT NULL,        
							updated_at DATETIME NOT NULL,             
							PRIMARY KEY (email)
						)ENGINE=MYISAM DEFAULT CHARSET=utf8
					]]>
				</value>
				<value>
					<![CDATA[
						CREATE INDEX o_accounts_IDX_0 on o_accounts(updated_at)
					]]>
				</value>
			</list>
		</property>
		<property name="localImportTableDropSQL">
			<list>
				<value>
					<![CDATA[
						DROP TABLE IF EXISTS o_accounts
					]]>
				</value>
			</list>
		</property>
	</bean>
	
	<bean id="friendships" class="com.tianji.r.core.conf.DatabaseJobConf">
		<property name="taskName" value="friendships" />
		<property name="remoteExportFile" value="friendships.csv" />
		<property name="remoteExportFolder" value="/tmp/" />
		<property name="remoteExportDataSource" ref="qaDataSource"/>
		<property name="remoteExportSCPConection" ref="qaSCPConnection"/>
		<property name="localImportDataSource" ref="rDataSource"/>
		<property name="remoteExportSQL">
			<value>
				<![CDATA[
					SELECT DISTINCT id,a,b,updated_at FROM(
						SELECT id,friend_id a,user_id b,updated_at 
						FROM friendships 
						WHERE user_id>friend_id 
						
						UNION
						SELECT id,user_id a,friend_id b,updated_at 
						FROM friendships 
						WHERE user_id<friend_id 
					) t1 
					ORDER BY a ASC, b ASC LIMIT 100
				]]>
			</value>
		</property>
		<property name="localFolder" value="D:/workspace/java/tianji-recommmendation/metadata/data/" />
		<property name="localImportTable" value="o_friendships" />
		<property name="localImportTableWay" value="OVERRIDE"/><!-- OVERRIDE,APPEND,UPDATE -->
		<property name="localImportTableCreateSQL">
			<list>
				<value>
					<![CDATA[
						CREATE TABLE o_friendships (
						   id INT NOT NULL UNIQUE,
						   a INT(11) NOT NULL,  
						   b INT(11) NOT NULL,           
						   updated_at DATETIME DEFAULT NULL,     
						   PRIMARY KEY (a,b)
						)ENGINE=MYISAM DEFAULT CHARSET=utf8
					]]>
				</value>
				<value>
					<![CDATA[
						CREATE INDEX o_friendships_IDX_0 on o_friendships(updated_at)
					]]>
				</value>
			</list>
		</property>
		<property name="localImportTableDropSQL">
			<list>
				<value>
					<![CDATA[
						DROP TABLE IF EXISTS o_friendships
					]]>
				</value>
			</list>
		</property>
	</bean>
	
	<bean id="dbsyncList" class="com.tianji.r.core.conf.DatabaseJobConfList">
		<property name="dbSyncConfList">
			<list>
				<!-- <ref bean="addressBooks" />
				<ref bean="accounts" />
				<ref bean="sameSchool"/>
				<ref bean="sameCompany"/>   -->
				<ref bean="friendships"/>
			</list>
		</property>
	</bean>
	
	<bean id="exportCSVListTask" class="com.tianji.r.core.job.task.ExportCSVListTask">
		<property name="jobConf" ref="dbsyncList" />
	</bean>
	
 	<bean id="scpGetCSVListTask" class="com.tianji.r.core.job.task.ScpGetCSVListTask">
		<property name="jobConf" ref="dbsyncList" />
	</bean>
	
	<bean id="importIntoDBListTask" class="com.tianji.r.core.job.task.ImportIntoDBListTask">
		<property name="jobConf" ref="dbsyncList" />
	</bean>

	<batch:job id="dbSyncJob">
		<batch:step id="exportCSVListStep" next="scpGetCSVListTaskStep">
			<batch:tasklet ref="exportCSVListTask" />
		</batch:step>
		<batch:step id="scpGetCSVListTaskStep" next="importIntoDBListStep">
			<batch:tasklet ref="scpGetCSVListTask" />
		</batch:step>
		<batch:step id="importIntoDBListStep">
			<batch:tasklet ref="importIntoDBListTask" />
		</batch:step>
	</batch:job>
	
	<!-- 	
	<bean id="exportCSVTask" class="com.tianji.r.core.job.task.ExportCSVTask">
		<property name="jobConf" ref="addressBooks" />
		<property name="dataSource" ref="qaDataSource" />
	</bean>
	
	<bean id="scpGetCSVTask" class="com.tianji.r.core.job.task.ScpGetCSVTask">
		<property name="jobConf" ref="addressBooks" />
		<property name="sCPConnection" ref="qaSCPConnection" />
	</bean>
	
	<bean id="importIntoDBTask" class="com.tianji.r.core.job.task.ImportIntoDBTask">
		<property name="jobConf" ref="addressBooks" />
		<property name="dataSource" ref="rDataSource" />
	</bean>
	
	<batch:job id="dbSyncJob">
		<batch:step id="exportCSVStep" next="scpGetCSVTaskStep">
			<batch:tasklet ref="exportCSVTask" />
		</batch:step>
		<batch:step id="scpGetCSVTaskStep" next="importIntoDBStep">
			<batch:tasklet ref="scpGetCSVTask" />
		</batch:step>
		<batch:step id="importIntoDBStep">
			<batch:tasklet ref="importIntoDBTask" />
		</batch:step>
	</batch:job>
	-->

</beans>
